---
layout: post
title:  "分布式事务."
category: 分布式事务
tags:  分布式事务 2pc 3pc
---

# 1、分布式特点


+ 分布性
	
		多台计算机在空间上随意分布，并且机器的分布情况也会随时变动.

+ 对等性

		组成分布式系统的所有计算机都是对等的.


+ 并发性

		分布式系统并发的操作共享的资源


+ 缺乏全局时钟

		分布式系统通过消息传递信息,很难确定事件的先后顺序,缺乏一个全局的时钟.


+ 故障总是会发生的

		组成分布式系统的计算机,都有可能发生任何形式的故障.


# 2、分布式的问题

+ 通信异常

		由于网络延迟,造成消息延迟,或者丢消息的现象


+ 网络分区(脑裂)

		在分布式系统中由于网络异常,最终导致只有部分节点相互通信,其他节点不能通信或者延时很大,
		这种情况称为网络分区,也叫脑裂.


# 3、一致性协议

## 3.1 2PC 与 3PC



### 3.1.1 2PC

		2PC 是 two-phase-commited 的缩写，即两阶段提交.是计算机网络尤其是数据库领域内，为了使
	基于分布式系统架构下的所有节点进行事务处理过程中保持原子性，一致性而设计的一种算法.绝大部
	分关系型数据库都是采用二阶段提交协议来完成分布式事务处理的.

+ 协议说明

	两阶段提交是指将事物提交过程分成两个阶段来进行处理,处理流程如下:


**阶段一:提交事物请求**
	
**1 事物询问**

	协调者向所有参与者发送事物内容,询问参与者是否可以执行事物提交操作,并开始等待参与者响应

**2 执行事物**

		
	各参与者节点执行事物操作,并将Undo和Redo信息记入事物日志中

**3 各参与者向协调者反馈事物询问的响应**

	如果参与者成功执行了事物操作,那么就反馈给协调者Yes响应,表示事物可执行,如果参与者没有成
	功执行事物,反馈给协调者No响应,表示事物不可以执行

**阶段二:执行事物提交**

**1 发送提交请求**

	协调者向所有参与者发出commit请求

**2 事物提交**

	参与者接收到commit请求后,会正式执行事物提交操作,完成事物提交之后释放事物执行期间占用的
	资源

**3 反馈事物提交结果**

	参与者事物提交成功后,向协调者发送ACK消息

**4 完成事物**

	协调者在接收到参与者的ack消息后,完成事物.

<font color="red">**中断事物处理**</font>

	如果任何一个参与者向协调者ack一个No响应,或者在超时之后协调者无法得到参与者的ACK消息,则
	会中断事物.

**1.发送事物回滚请求**

	协调者向参与者发送rollback请求

**2.事物回滚**

	参与者接收到Rollback请求后,会利用在阶段一中记录的UNDO信息进行事物回滚操作,回滚后释放事物
	占用的资源

**3.反馈事物回滚结果**

	参与者在事物回滚后向协调者发送ＡＣＫ信息．

**4.中断事物**

	协调者在接收到所有参与者反馈的ACK信息后,中断事物.

<font color="red">**两阶段提交示意图:**</font>

![两阶段提交示意图](https://ywendy.github.io/img/两阶段提交示意图.jpg)


**两阶段提交示意图02**

![](https://ywendy.github.io/img/两阶段提交02.jpg)


**中断事物示意图**

![](https://ywendy.github.io/img/两阶段提交-中断事物.jpg)


<font color="red">**两阶段提交优缺点:**</font>


+ 优点:

		原理简单,实现方便

+ 缺点:

		同步阻塞,单点问题,脑裂,太过保守


	1.<strong>同步阻塞:</strong>

			两阶段提交出现的最大问题就是同步阻塞,极大的限制了分布式系统的性能在两阶段提交的
			过程中,所有参与事物提交的过程都处于阻塞状态,也即是说各个参与者在等待其他参与者
			响应的过程中,无法进行其他的操作.

	2.<strong>单点问题:</strong>

			协调者只有一个,一旦出现问题,整个过程将无法运转

	3.<strong>数据不一致:</strong>

			在阶段二中,协调者向参与者发送commit请求时,只有部分参与者收到了commit请求,另一部
			分可能因为网络原因,或者协调者自身问题等没有收到commit请求,将会出现数据不一致的
			问题

	4.<strong>太过保守:</strong>

			在协调者向参与者发送了请求后,如果参与者故障了,协调者只能通过自身的超时机制来判断
			是否需要中断事物,显得有些保守.









